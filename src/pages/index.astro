---
// ==========================================
// PÁGINA PRINCIPAL (ENTRY POINT)
// ==========================================
// Este archivo actúa como el controlador principal de la aplicación.
// Se encarga de:
// 1. Recibir los parámetros de búsqueda desde la URL (SSR).
// 2. Llamar al servicio de clima para obtener datos.
// 3. Decidir qué renderizar: Skeleton (carga), Error (sin datos), o la UI del clima.

// --- Imports de Layouts y Componentes Base ---
import Layout from "../layouts/Layout.astro"; // Contenedor HTML base con estilos globales
import Header from "../layouts/Header.astro"; // Barra superior con Logo y selector de unidades
import Hero from "../components/weather/Hero.astro"; // Título principal "¿How's the sky looking today?"

// --- Imports de Componentes del Clima ---
import HourlyForecast from "../components/weather/HourlyForecast.astro"; // Barra lateral con pronóstico por horas
import DailyForecast from "../components/weather/DailyForecast.astro"; // Grilla con pronóstico de 7 días
import StatCard from "../components/weather/StatCard.astro"; // Tarjeta principal del día actual
import SearchBar from "../components/weather/SearchBar.astro"; // Barra de búsqueda con autocompletado

// --- Imports de Estados de UI (Error y Carga) ---
import ErrorState from "../Error/ErrorState.astro"; // Pantalla de error amigable
import SkeletonStatCard from "../components/weather/skeleton/SkeletonStatCard.astro"; // Placeholder animado para StatCard
import SkeletonDailyForecast from "../components/weather/skeleton/SkeletonDailyForecast.astro"; // Placeholder animado para DailyForecast
import SkeletonHourlyForecast from "../components/weather/skeleton/SkeletonHourlyForecast.astro"; // Placeholder animado para HourlyForecast

// --- Lógica del Servidor (Server-Side Rendering) ---
import { loadWeatherFromUrl } from "../services/weather";

// Extraemos los datos del clima basándonos en la query string ?city=...
// Si no hay params, usa una ciudad por defecto o devuelve null si falla.
const weatherData = await loadWeatherFromUrl(Astro.url.searchParams);
---

<Layout>
    {
        /* 
      === ZONA FIJA === 
      Elementos que siempre están visibles, independientemente del estado de la data.
    */
    }
    <Header />
    <Hero />
    <SearchBar />

    {
        /* 
      === ZONA DINÁMICA === 
      Renderizado condicional basado en la disponibilidad de weatherData.
    */
    }

    {
        weatherData ? (
            /* 
               CASO ÉXITO: Tenemos datos del clima.
               Renderizamos el dashboard principal dividido en dos columnas para escritorio.
            */
            <>
                <div class="flex flex-row gap-5 max-w-7xl my-0 mx-20 min-h-4/5 items-stretch pb-10">
                    {/* COLUMNA IZQUIERDA: Tarjeta principal y Pronóstico diario */}
                    <div class="flex-3 flex flex-col gap-5 h-auto">
                        <StatCard weatherData={weatherData} />
                        <DailyForecast
                            weatherData={weatherData.weather}
                            class="flex-1"
                        />
                    </div>
                    {/* COLUMNA DERECHA (Sidebar): Pronóstico por horas */}
                    <aside class="flex-1 flex flex-col h-auto">
                        <HourlyForecast
                            weatherData={weatherData.weather}
                            class="flex-1 h-full"
                        />
                    </aside>
                </div>
            </>
        ) : (
            /* 
               CASO FALLO / NO HAY COINCIDENCIAS: No se encontraron datos para la ciudad.
               Mostramos el estado de error.
            */
            <ErrorState />
        )
    }
</Layout>

---
import Hours from "./ui_HourlyForestcast/Hours.astro";
import OptionDays from "./ui_HourlyForestcast/OptionDays.astro";
import { getCoordinates, getWeather } from "../../services/weather.ts";
import { getFilteredHours } from "../../services/weatherUtils.ts"; // Asegúrate que esta ruta esté bien

// 1. FECHA LOCAL (Para marcar "hoy" correctamente)
// Usamos 'sv-SE' porque devuelve formato ISO (YYYY-MM-DD) y respeta tu zona horaria local
const now = new Date();
const localDate = now.toLocaleDateString("sv-SE");

const cityParam = Astro.url.searchParams.get("city") || "Bogota";
const cityInfo = await getCoordinates(cityParam);
const weatherData = cityInfo
    ? await getWeather(cityInfo.latitude, cityInfo.longitude)
    : null;

// 2. ARREGLO DEL ERROR: Inicialización directa
// Si hay weatherData, mapeamos los días. Si no, devolvemos array vacío.
const allDaysData = weatherData
    ? weatherData.daily.time.map((day) => {
          return {
              date: day,
              // Llamamos a tu utilidad para obtener las horas de ESE día específico
              hours: getFilteredHours(weatherData.hourly, day),
          };
      })
    : [];
---

<section class="theme-card flex flex-col gap-2 max-w-[340px] m-2 p-2">
    <header class="flex flex-row justify-between px-2 items-center">
        <h2 class="font-DMSans text-xl font-semibold text-white">
            Hourly Forecast
        </h2>

        {
            weatherData && (
                <OptionDays
                    days={weatherData.daily.time}
                    selectedDay={localDate}
                />
            )
        }
    </header>

    <div id="hours-container">
        {/* Renderizamos las 7 listas de la semana */}
        {
            allDaysData.map((dayData) =>
                // Solo renderizamos si 'dayData.hours' no es null
                dayData.hours ? (
                    <div
                        id={`hours-${dayData.date}`}
                        class={`hourly-list ${dayData.date === localDate ? "" : "hidden"}`}
                    >
                        <Hours hourly={dayData.hours} />
                    </div>
                ) : null,
            )
        }

        {/* Mensaje de carga o error si no hay datos */}
        {
            allDaysData.length === 0 && (
                <p class="text-white/50 text-sm p-2">Cargando datos...</p>
            )
        }
    </div>
</section>

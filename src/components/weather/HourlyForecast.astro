---
// ==========================================
// COMPONENTE: PRONÓSTICO POR HORAS (SIDEBAR)
// ==========================================
// Muestra la lista de temperaturas por hora.
// - Permite cambiar de día usando 'OptionDays' (Tabs).
// - Filtra las horas para mostrar solo 24h desde el momento actual (si es hoy) o desde las 00:00.

import Hours from "./ui_HourlyForestcast/Hours.astro";
import OptionDays from "./ui_HourlyForestcast/OptionDays.astro";
import { getFilteredHours } from "../../services/weatherUtils.ts";

const { class: className, weatherData } = Astro.props;

// 1. FECHA LOCAL (Para marcar "hoy" correctamente)
const now = new Date();
const localDate = now.toLocaleDateString("sv-SE");

// 2. PROCESAMIENTO DE DATOS DIARIOS
const allDaysData = weatherData
    ? weatherData.daily.time.map((day: string) => {
          return {
              date: day,
              // Llamamos a tu utilidad para obtener las horas de ESE día específico
              hours: getFilteredHours(weatherData.hourly, day),
          };
      })
    : [];

// 4. SELECCIÓN INICIAL
// Para evitar que la lista aparezca vacía si la zona horaria del servidor
// es distinta a la de la ciudad buscada, usamos el PRIMER día de la data.
const selectedDay = weatherData ? weatherData.daily.time[0] : localDate;
---

<section
    class:list={[
        "theme-card flex flex-col gap-2 max-w-[340px] m-2 p-2 lg:m-0",
        className,
    ]}
>
    {/* HEADER: Título + Selector de Días */}
    <header class="flex flex-row justify-between px-2 items-center">
        <h2 class="font-DMSans text-xl font-semibold text-white">
            Hourly Forecast
        </h2>

        {
            weatherData && (
                <OptionDays
                    days={weatherData.daily.time}
                    selectedDay={selectedDay}
                />
            )
        }
    </header>

    {/* LISTAS DE HORAS (Una por día, ocultas/visibles según selección) */}
    <div id="hours-container">
        {
            allDaysData.map((dayData: any) =>
                // Solo renderizamos si hay datos válidos para ese día
                dayData.hours ? (
                    <div
                        id={`hours-${dayData.date}`}
                        class={`hourly-list ${dayData.date === selectedDay ? "" : "hidden"}`}
                    >
                        <Hours hourly={dayData.hours} />
                    </div>
                ) : null,
            )
        }

        {/* Mensaje de carga o error si no hay datos disponibles */}
        {
            allDaysData.length === 0 && (
                <p class="text-white/50 text-sm p-2">Cargando datos...</p>
            )
        }
    </div>
</section>

---
// Imports
import WeatherIcon from "../weather/ui_HourlyForestcast/WeatherIcon.astro";
import { loadWeatherFromUrl } from "../../services/weather.ts";
import { getStackCardData } from "../../services/weatherUtils.ts";

// 1. Carga Autónoma
const dataResponse = await loadWeatherFromUrl(Astro.url.searchParams);

// 2. GUARDIA DE SEGURIDAD
// Como index.astro ya se encargó de verificar errores, aquí asumimos que hay datos.
// Pero si fallara, esto evita que la página explote.
if (!dataResponse) {
    return null;
}

// 3. Procesamos los datos con seguridad
const info = getStackCardData(
    dataResponse.weather,
    dataResponse.geo,
    dataResponse.units,
);
---

<section
    class="max-w-[450px] p-2 flex justify-center items-center lg:min-w-full"
>
    {/* YA NO HAY IF/ELSE, SOLO EL CONTENIDO DEL CLIMA */}

    <div
        class="grid grid-cols-2 grid-rows-8 h-[500px] w-[450px] gap-4 lg:grid-cols-4 lg:grid-rows-6 lg:min-w-full lg:h-[400px]"
    >
        {/* 1. MAIN CARD */}
        <div
            class="col-span-2 row-span-4 lg:flex lg:flex-row lg:items-center lg:justify-between lg:col-span-4 lg:row-span-4 theme-card bg-[url('/images/bg-today-small.svg')] lg:bg-[url('/images/bg-today-large.svg')] bg-cover bg-center bg-no-repeat p-5 flex flex-col justify-between relative overflow-hidden group"
        >
            <div class="absolute inset-0 bg-black/10 z-0"></div>

            <div
                class="z-10 flex flex-col items-center lg:items-start lg:text-start"
            >
                <h2
                    class="font-bold text-white font-DMSans text-center text-2xl drop-shadow-md lg:text-start"
                >
                    {info.city}, <span class="text-white/90 lg:text-start"
                        >{info.country}</span
                    >
                </h2>
                <p
                    class="text-white/80 text-sm mt-1 font-DMSans font-semibold capitalize text-center drop-shadow-sm"
                >
                    {info.date}
                </p>
            </div>

            <div
                class="flex items-center justify-between z-10 mt-2 px-2 lg:gap-10"
            >
                <div class="w-32 h-32 lg:w-28 lg:h-28">
                    <WeatherIcon
                        code={info.code}
                        class="w-full h-full drop-shadow-2xl filter"
                    />
                </div>

                <div class="flex flex-col items-end">
                    <div class="flex items-start">
                        <span
                            class="text-8xl font-DMSans font-bold text-white tracking-tighter drop-shadow-lg"
                        >
                            {info.temp}
                        </span>
                        <span
                            class="text-4xl font-DMSans font-bold text-white/80 mt-4 ml-1"
                        >
                            {info.tempUnit}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        {/* 2. FEELS LIKE */}
        <div
            class="row-span-2 row-start-5 theme-card lg:col-span-1 lg:row-span-2 theme-card-info-main"
        >
            <span class="theme-card-info-sub">Feels like</span>
            <span class="text-2xl font-DMSans text-white">
                {info.feelsLike}{info.tempUnit}
            </span>
        </div>

        {/* 3. HUMIDITY */}
        <div
            class="row-span-2 row-start-5 theme-card lg:col-span-1 lg:row-span-2 theme-card-info-main"
        >
            <span class="theme-card-info-sub">Humidity</span>
            <span class="text-2xl font-DMSans text-white">
                {info.humidity}%
            </span>
        </div>

        {/* 4. WIND */}
        <div
            class="row-span-2 row-start-7 theme-card lg:col-span-1 lg:row-span-2 theme-card-info-main"
        >
            <span class="theme-card-info-sub">Wind</span>
            <div class="flex items-baseline gap-1">
                <span class="text-2xl font-DMSans text-white">
                    {info.wind}
                </span>
                <span class="text-sm text-white/60 font-medium">
                    {info.windUnit}
                </span>
            </div>
        </div>

        {/* 5. PRECIPITATION */}
        <div
            class="row-span-2 row-start-7 theme-card lg:col-span-1 lg:row-span-2 theme-card-info-main"
        >
            <span class="theme-card-info-sub">Precipitation</span>
            <div class="flex items-baseline gap-1">
                <span class="text-2xl font-DMSans text-white">
                    {info.precip}
                </span>
                <span class="text-sm text-white/60 font-medium">
                    {info.precipUnit}
                </span>
            </div>
        </div>
    </div>
</section>
